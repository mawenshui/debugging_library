## 说明
- 本文件为早期方案记录；当前功能已落地并以 `docs/职业模式与字段模板.md` 为准。

## 需求确认结果
- 职业扩展到 7 类。
- 每类职业固定字段控制在 6–8 个，其余走自定义字段。
- 必须确保离线导入/导出不因本次改动受影响。

## 核心思路（不破坏导入导出）
- **不改数据库 schema、不改包 schema**：`problem.environmentJson` 仍是 JSON 字符串，离线包仍按现有 JSONL/附件/manifest 机制导入导出。
- “职业模式”仅影响：
  - 设置项（保存到 `config/appsettings.json`）
  - UI（问题编辑窗口）显示的固定字段集合、默认模板行、自定义字段下拉建议
- 导入导出端（`SqlitePackageTransferService`）只把 `environmentJson` 当字符串读写，不解析内部字段，因此新增/变更 env key 不会影响导入导出。

## 文档优先交付（先做）
- 新增文档 `docs/职业模式与字段模板.md`，结构如下：
  - 7 类职业清单（含展示名称与内部 Id）
  - 每类职业：
    - 固定字段（6–8 个）：`key/中文显示名/校验类型（无、IP、Port、必填等）/提示`
    - 推荐自定义字段（作为 Key 下拉建议）
    - 新建默认模板行（预填的自定义字段行）
  - 字段命名规则：固定字段用**稳定英文 key**写入 `environmentJson`，UI label 可调整。

### 建议的 7 类职业（默认=通用）
1) 通用（General）
2) 硬件工程师（Hardware）
3) 软件工程师（Software）
4) 嵌入式工程师（Embedded）
5) UI 工程师（UI）
6) 测试/QA（QA）
7) 运维/现场实施（Ops）

## 代码改造计划（文档确认后执行）
### 1) 设置中增加“职业/角色”并持久化
- 扩展 `IAppSettingsStore`：读写 `User.Profession`。
- 扩展 `JsonAppSettingsStore`：
  - 读取不到时默认 `General`（向后兼容旧配置文件）。
  - 写入时保存 `User.Profession` 字符串。
- 扩展 `IUserContext/UserContext`：增加 `CurrentProfession` 与变更事件。
- App 启动时从配置加载 profession（缺省 General）。
- 更新设置窗口：`UserSettingsWindow` 增加职业下拉框（ComboBox），与用户名同一页保存。

### 2) 引入“职业 Profile（模板）”模型
- 新增 `ProfessionProfile`：
  - `Id/DisplayName`
  - `StructuredFields`（固定字段定义列表，长度 6–8）
  - `CommonKeys`（自定义字段 Key 下拉建议）
  - `DefaultCustomEntries`（新建默认行）
- 新增 `IProfessionProfileProvider`：根据当前职业返回 profile。

### 3) 将问题编辑窗口的固定字段改为“按 profile 渲染”
当前固定字段在 XAML 写死（设备型号/版本/工位等）。改造为：
- `ProblemEditorViewModel` 增加：
  - `StructuredFieldRows`（可编辑的固定字段行：key/label/value/校验类型）
  - `CommonKeys` 改为来自 profile
  - 新建时按 `DefaultCustomEntries` 预填充 `EnvironmentEntries`
  - 校验逻辑改为**只校验当前 profile 中声明的字段**（例如只有当 profile 包含 IP/Port 才校验 IP/Port）
- `ProblemEditorWindow.xaml`：
  - 用 `ItemsControl + UniformGrid(两列)` 渲染固定字段行（最多 8 个，视觉更统一）。
  - 保留现有“自定义扩展字段”区块，但其 Key 下拉来源切换为 profile。

### 4) 统一 EnvironmentJson 的生成/解析策略（与导入导出无耦合）
- 生成：先写入 profile 固定字段（key->value），再写入自定义字段（若 key 与固定字段冲突则跳过或覆盖策略按文档约定）。
- 解析：打开编辑时，从 `environmentJson` 中：
  - 把当前 profile 的固定字段 key 映射到固定字段区；
  - 其余 key 全部归入自定义字段区（保证跨职业编辑也不丢字段）。
- 可保留旧的 `KnownKeys` 作为 legacy 兼容（不强依赖“全局保留 key 列表”）。

### 5) 关联主流程
- `WpfDialogService.ShowProblemEditorAsync` 需要能拿到当前职业/profile（通过 DI 注入 `IUserContext` 或 `IProfessionProfileProvider`），构造 `ProblemEditorViewModel` 时传入。
- 主界面新建/编辑逻辑不改业务语义，只改“初始模板/字段集合”的来源。

## 导入导出不受影响的保障措施
- 明确不修改：
  - SQLite 表结构、迁移版本号
  - 离线包 `manifest.json` schemaVersion 与 checksums
  - JSONL 结构（Problem 的 `environmentJson` 仍为 string）
- 增加回归用例：
  - 构造带新字段 key 的 `environmentJson`，执行导出→导入→再读取，断言 `environmentJson` 字符串内容包含这些 key（至少确保不丢失/不异常）。

## 验证计划
- 单测：
  - `JsonAppSettingsStore` 对 `User.Profession` 的读写与旧文件兼容
  - Profile 定义：每类职业固定字段数量在 6–8
  - 导出/导入回归：带新 env key 的记录可完整导出并成功导入
- 手动验证：
  - 设置切换职业后，新建窗口固定字段/默认自定义行/下拉建议即时变化
  - 用不同职业编辑同一条记录，非当前职业字段不会丢失（会落到自定义区）

## 交付物
- 文档：`docs/职业模式与字段模板.md`
- 功能：设置支持职业；问题编辑页按职业模板展示；新建默认模板；导入导出回归测试

如果你确认这个方案，我会先提交文档草案（含 7 类职业的字段清单），你点头后再开始做代码改造与回归测试。
