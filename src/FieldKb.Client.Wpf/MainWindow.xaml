<local:ThemedWindow x:Class="FieldKb.Client.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:FieldKb.Client.Wpf"
        mc:Ignorable="d"
        Title="{Binding Title}" Height="640" Width="1080" WindowStartupLocation="CenterScreen" MinHeight="560" MinWidth="980">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <Style x:Key="Button.CopyValue" TargetType="{x:Type Button}" BasedOn="{StaticResource Button.Outline}">
            <Setter Property="Padding" Value="8,2" />
            <Setter Property="MinHeight" Value="0" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>
    </Window.Resources>
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border Style="{StaticResource Card}" Padding="16">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <StackPanel>
                    <TextBlock FontSize="20" FontWeight="SemiBold" Text="{Binding Title}" />
                    <TextBlock Foreground="{StaticResource Brush.SubText}" Margin="0,3,0,0" Text="{Binding Subtitle}" />
                </StackPanel>

                <WrapPanel Grid.Row="1" Margin="0,12,0,0" VerticalAlignment="Center">
                    <StackPanel Margin="0,0,18,10">
                        <TextBlock Foreground="{StaticResource Brush.SubText}" FontSize="12" Text="本机实例ID" />
                        <Button Style="{StaticResource Button.CopyValue}"
                                HorizontalAlignment="Left"
                                ToolTip="点击复制本机实例ID"
                                Command="{Binding CopyLocalInstanceIdCommand}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8C8;" Margin="0,0,6,0" />
                                <TextBlock Text="{Binding LocalInstanceId}" />
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <StackPanel Margin="0,0,18,10">
                        <TextBlock Foreground="{StaticResource Brush.SubText}" FontSize="12" Text="对端标识（增量水位）" />
                        <TextBox Width="240" Height="36"
                                 Tag="用于增量导出：填写对端实例ID，可按水位导出新增/更新记录"
                                 ToolTip="用于增量导出：填写对端实例ID，可按水位导出新增/更新记录"
                                 Text="{Binding RemoteInstanceId, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <StackPanel Margin="0,0,18,10">
                        <TextBlock Foreground="{StaticResource Brush.SubText}" FontSize="12" Text="当前用户" />
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontSize="12" Text="{Binding CurrentUserName}" />
                            <TextBlock FontSize="12" Foreground="{StaticResource Brush.SubText}" Text="{Binding CurrentProfessionDisplayName, StringFormat=（{0}）}" />
                        </StackPanel>
                    </StackPanel>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding NewProblemCommand}"
                            ToolTip="新建一条问题记录（现象/原因/解决方案）">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE710;" Margin="0,0,6,0" />
                            <TextBlock Text="新建" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding ImportCommand}"
                            ToolTip="导入离线包（.zip），自动合并并生成冲突">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE74A;" Margin="0,0,6,0" />
                            <TextBlock Text="导入" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding ExportIncrementalCommand}"
                            ToolTip="导出增量离线包（需要设置对端标识作为水位）">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE898;" Margin="0,0,6,0" />
                            <TextBlock Text="导出（增量）" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding ExportFullCommand}"
                            ToolTip="导出全量离线包（包含全部记录）">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE898;" Margin="0,0,6,0" />
                            <TextBlock Text="导出（全量）" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding BulkExportCommand}"
                            ToolTip="批量导出为 Excel/CSV/JSONL（支持按职业/标签/更新时间范围筛选）">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8A5;" Margin="0,0,6,0" />
                            <TextBlock Text="批量导出" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding SpreadsheetImportCommand}"
                            ToolTip="从 Excel（.xlsx）导入问题数据，提供字段映射与校验报告">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7C3;" Margin="0,0,6,0" />
                            <TextBlock Text="表单导入" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding OpenTagManagerCommand}"
                            ToolTip="管理标签：新增/删除">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8EC;" Margin="0,0,6,0" />
                            <TextBlock Text="标签" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding OpenConflictsCommand}"
                            ToolTip="处理导入产生的冲突记录">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7BA;" Margin="0,0,6,0" />
                            <TextBlock Text="冲突" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding OpenLogsCommand}"
                            ToolTip="查看本次启动日志（支持实时追加）">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE9D9;" Margin="0,0,6,0" />
                            <TextBlock Text="日志" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding OpenSettingsCommand}"
                            ToolTip="设置用户名与职业/角色">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE713;" Margin="0,0,6,0" />
                            <TextBlock Text="设置" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,10,10" Style="{StaticResource Button.Toolbar}" Command="{Binding OpenAboutCommand}"
                            ToolTip="查看产品信息">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE946;" Margin="0,0,6,0" />
                            <TextBlock Text="关于" />
                        </StackPanel>
                    </Button>

                    <Button Margin="0,0,0,10" Style="{StaticResource Button.Toolbar}" Command="{Binding OneClickAddCommand}"
                            ToolTip="测试：一键随机新增 10 条完整记录（含环境字段/标签/附件）">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE109;" Margin="0,0,6,0" />
                            <TextBlock Text="一键添加" />
                        </StackPanel>
                    </Button>
                </WrapPanel>
            </Grid>
        </Border>

        <Grid Grid.Row="1" Margin="0,14,0,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox Height="42" FontSize="14"
                         Tag="搜索：标题/现象/原因/方案/环境信息 关键字包含匹配；空格分词（AND）；留空显示全部"
                         ToolTip="搜索：标题/现象/原因/方案/环境信息 关键字包含匹配；空格分词（AND）；留空显示全部"
                         Text="{Binding QueryText, UpdateSourceTrigger=PropertyChanged}" />
                <ProgressBar Grid.Column="1" Width="160" Height="8" Margin="12,16,0,0"
                             IsIndeterminate="True"
                             Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" />
            </Grid>

            <Grid Grid.Row="1" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="380" />
                    <ColumnDefinition Width="14" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Border Style="{StaticResource Card}" Padding="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock FontWeight="SemiBold" Text="标签筛选" />
                            <Button Grid.Column="1" Style="{StaticResource Button.Outline}" Padding="12,8" Content="清空" Command="{Binding ClearTagFiltersCommand}" />
                            </Grid>
                            <StackPanel Grid.Row="1" Margin="0,10,0,0">
                                <TextBlock Foreground="{StaticResource Brush.SubText}" FontSize="12" Text="职业筛选" />
                                <ComboBox Height="36" Margin="0,6,0,0"
                                          ItemsSource="{Binding ProfessionFilters}"
                                          DisplayMemberPath="DisplayName"
                                          SelectedValuePath="Id"
                                          SelectedValue="{Binding SelectedProfessionFilterId, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Height="84" Margin="0,10,0,0">
                                <ItemsControl ItemsSource="{Binding TagFilters}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox Margin="0,0,12,8" IsChecked="{Binding IsSelected, Mode=TwoWay}" Content="{Binding Name}" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <Grid Grid.Row="1" Margin="0,12,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="10" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Button Style="{StaticResource Button.Outline}" Padding="12,8" Content="上一页" Command="{Binding PrevPageCommand}" />
                        <TextBlock Grid.Column="2" VerticalAlignment="Center" Foreground="{StaticResource Brush.SubText}" Text="{Binding PageInfoText}" />
                        <Button Grid.Column="4" Style="{StaticResource Button.Outline}" Padding="12,8" Content="下一页" Command="{Binding NextPageCommand}" />
                    </Grid>

                    <ListBox Grid.Row="2" Margin="0,12,0,0" ItemsSource="{Binding Results}" SelectedItem="{Binding SelectedResult}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="14,10">
                                    <local:HighlightTextBlock FontSize="14" FontWeight="SemiBold"
                                                             SourceText="{Binding Title}"
                                                             TermsText="{Binding DataContext.QueryText, RelativeSource={RelativeSource AncestorType=Window}}"
                                                             TextTrimming="CharacterEllipsis"
                                                             HighlightBackground="{StaticResource Brush.Selection}" />
                                    <local:HighlightTextBlock Margin="0,6,0,0" Foreground="{StaticResource Brush.SubText}" FontSize="12"
                                                             SourceText="{Binding Snippet}"
                                                             TermsText="{Binding DataContext.QueryText, RelativeSource={RelativeSource AncestorType=Window}}"
                                                             TextTrimming="CharacterEllipsis"
                                                             HighlightBackground="{StaticResource Brush.Selection}" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>

                <Border Grid.Column="2" Style="{StaticResource Card}" Padding="16">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock FontSize="18" FontWeight="SemiBold"
                                       Text="{Binding SelectedProblem.Title, TargetNullValue=请选择左侧条目}" />

                            <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                <Button Margin="0,0,10,0" Style="{StaticResource Button.Outline}" Content="编辑" Command="{Binding EditProblemCommand}" />
                                <Button Margin="0,0,10,0" Style="{StaticResource Button.Outline}" Content="删除" Command="{Binding DeleteProblemCommand}" />
                                <Button Content="添加附件" Command="{Binding AddAttachmentsCommand}" />
                            </StackPanel>

                            <TextBlock Margin="0,14,0,6" FontWeight="SemiBold" Text="标签" />
                            <Border Style="{StaticResource GlassPanel}" CornerRadius="14" Padding="10">
                                <TextBlock Foreground="{StaticResource Brush.SubText}" TextWrapping="Wrap" Text="{Binding SelectedTagsText}" />
                            </Border>

                            <TextBlock Margin="0,14,0,6" FontWeight="SemiBold" Text="现象" />
                            <TextBlock TextWrapping="Wrap" Text="{Binding SelectedProblem.Symptom}" />

                            <TextBlock Margin="0,14,0,6" FontWeight="SemiBold" Text="原因" />
                            <TextBlock TextWrapping="Wrap" Text="{Binding SelectedProblem.RootCause}" />

                            <TextBlock Margin="0,14,0,6" FontWeight="SemiBold" Text="解决方案" />
                            <TextBlock TextWrapping="Wrap" Text="{Binding SelectedProblem.Solution}" />

                            <TextBlock Margin="0,14,0,6" FontWeight="SemiBold" Text="环境信息" />
                            <Border Style="{StaticResource GlassPanel}" CornerRadius="14" Padding="10">
                                <TextBlock Foreground="{StaticResource Brush.SubText}" TextWrapping="Wrap" Text="{Binding SelectedEnvironmentText}" />
                            </Border>

                            <TextBlock Margin="0,14,0,6" FontWeight="SemiBold" Text="附件" />
                            <ListBox ItemsSource="{Binding SelectedAttachments}" BorderBrush="{StaticResource Brush.Border}" BorderThickness="1">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="14,10">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel>
                                                <TextBlock FontWeight="SemiBold" Text="{Binding FileName}" TextTrimming="CharacterEllipsis" />
                                                <TextBlock Foreground="{StaticResource Brush.SubText}" FontSize="12" Text="{Binding SizeBytes}" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                <Button Margin="0,0,10,0" Style="{StaticResource Button.Outline}" Padding="10,6" Content="预览"
                                                        Command="{Binding DataContext.PreviewAttachmentCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}" />
                                                <Button Style="{StaticResource Button.Outline}" Padding="10,6" Content="外部打开"
                                                        Command="{Binding DataContext.OpenAttachmentCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}" />
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Grid>

        <Border Grid.Row="2" Margin="0,14,0,0" Style="{StaticResource GlassPanel}" CornerRadius="14">
            <StatusBar Background="{x:Null}" BorderThickness="0">
                <StatusBarItem>
                    <TextBlock Foreground="{StaticResource Brush.SubText}" Text="{Binding StatusText}" />
                </StatusBarItem>
            </StatusBar>
        </Border>
    </Grid>
</local:ThemedWindow>
