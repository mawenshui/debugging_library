<local:ThemedWindow x:Class="FieldKb.Client.Wpf.ProblemEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:FieldKb.Client.Wpf"
        mc:Ignorable="d"
        Title="问题编辑" Height="660" Width="900" WindowStartupLocation="CenterOwner">
    <Grid Margin="16">
        <Border Style="{StaticResource Card}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <StackPanel>
                    <TextBlock FontSize="18" FontWeight="SemiBold" Text="问题编辑" />
                    <TextBlock Margin="0,4,0,0" Foreground="{StaticResource Brush.SubText}" Text="窗口较小时可滚动查看全部字段。" />
                </StackPanel>

                <ScrollViewer Grid.Row="1" Margin="0,14,0,0" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="标题" FontWeight="SemiBold"/>
                        <TextBox Height="40" Margin="0,8,0,12"
                                 Text="{Binding TitleText, UpdateSourceTrigger=PropertyChanged, ValidatesOnNotifyDataErrors=True}"/>

                        <TextBlock Text="标签" FontWeight="SemiBold"/>
                        <Border Margin="0,8,0,12" Style="{StaticResource GlassPanel}" CornerRadius="14" Padding="12">
                            <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="90">
                                <ItemsControl ItemsSource="{Binding TagOptions}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox Margin="0,0,12,8" IsChecked="{Binding IsSelected, Mode=TwoWay}" Content="{Binding Name}" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Border>

                        <TextBlock Text="现象" FontWeight="SemiBold"/>
                        <TextBox Height="120" Margin="0,8,0,12" TextWrapping="Wrap" AcceptsReturn="True"
                                 Text="{Binding Symptom, UpdateSourceTrigger=PropertyChanged}"/>

                        <TextBlock Text="原因" FontWeight="SemiBold"/>
                        <TextBox Height="120" Margin="0,8,0,12" TextWrapping="Wrap" AcceptsReturn="True"
                                 Text="{Binding RootCause, UpdateSourceTrigger=PropertyChanged}"/>

                        <TextBlock Text="解决方案" FontWeight="SemiBold"/>
                        <TextBox Height="120" Margin="0,8,0,12" TextWrapping="Wrap" AcceptsReturn="True"
                                 Text="{Binding Solution, UpdateSourceTrigger=PropertyChanged}"/>

                        <Grid Margin="0,6,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="环境信息" FontWeight="SemiBold"/>
                            <Button Grid.Column="1" Style="{StaticResource Button.Outline}" Padding="10,6" Command="{Binding AddEnvironmentRowCommand}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE710;" Margin="0,0,6,0" />
                                    <TextBlock Text="添加字段" />
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Border Margin="0,10,0,0" Style="{StaticResource GlassPanel}" CornerRadius="14" Padding="12">
                            <StackPanel>
                                <TextBlock Foreground="{StaticResource Brush.SubText}" Text="固定字段" />
                                <ItemsControl Margin="0,10,0,0" ItemsSource="{Binding FixedFields}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Columns="2" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="0,0,12,12">
                                                <TextBlock Foreground="{StaticResource Brush.SubText}" Text="{Binding Label}" />
                                                <TextBox Height="34" Margin="0,6,0,0"
                                                         Tag="{Binding Placeholder}"
                                                         Text="{Binding Value, UpdateSourceTrigger=PropertyChanged, ValidatesOnNotifyDataErrors=True}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>

                        <Border Margin="0,10,0,0" Style="{StaticResource GlassPanel}" CornerRadius="14" Padding="12">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="8" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <TextBlock Foreground="{StaticResource Brush.SubText}" Text="自定义扩展字段" />

                                        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" MaxHeight="220">
                                    <ItemsControl ItemsSource="{Binding EnvironmentEntries}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Margin="0,0,0,8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="260" />
                                                        <ColumnDefinition Width="12" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="10" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <ComboBox Height="36"
                                                              ItemsSource="{Binding DataContext.CommonKeys, RelativeSource={RelativeSource AncestorType=Window}}"
                                                              IsEditable="True"
                                                              HorizontalContentAlignment="Stretch"
                                                              Text="{Binding Key, UpdateSourceTrigger=PropertyChanged}">
                                                        <ComboBox.ToolTip>
                                                            <StackPanel>
                                                                <TextBlock Text="选择常用中文字段名，或直接输入自定义字段名" />
                                                                <TextBlock Foreground="{StaticResource Brush.SubText}" Text="{Binding Key, StringFormat=当前：{0}}" />
                                                            </StackPanel>
                                                        </ComboBox.ToolTip>
                                                        <ComboBox.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Text="{Binding}" TextWrapping="Wrap" MaxWidth="420" />
                                                            </DataTemplate>
                                                        </ComboBox.ItemTemplate>
                                                    </ComboBox>
                                                    <TextBox Grid.Column="2" Height="36" Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}" />
                                                    <Button Grid.Column="4" Style="{StaticResource Button.Outline}" Padding="10,6"
                                                            Command="{Binding DataContext.RemoveEnvironmentRowCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                            CommandParameter="{Binding}">
                                                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE74D;" />
                                                    </Button>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Grid>
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,14,0,0">
                    <Button Width="110" Margin="0,0,10,0" Style="{StaticResource Button.Outline}" Content="取消" Command="{Binding CancelCommand}"/>
                    <Button Width="110" Content="保存" Command="{Binding SaveCommand}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</local:ThemedWindow>
