# 发布与打包

## 发布目标

- 提供两种分发形态：
  - 免安装版：解压即用（便于现场快速分发）
  - 安装包：标准安装/卸载（便于企业内分发）

## 目录结构约定

- `<程序目录>\\config\\`：配置文件固定目录
  - `appsettings.json`：默认配置（随发布）
  - `appsettings.user.json`：用户配置（运行期写入/升级保留）
  - `instance.json`：本机实例标识（首次运行生成）
- `<程序目录>\\data\\`：数据与附件与日志
  - `kb.sqlite`：SQLite 数据库
  - `attachments\\`：附件对象存储（按 contentHash）
  - `logs\\`：日志文件（每次启动一个 `.log` 文件）

## 免安装版（解压即用）

发布：

- 使用发布配置文件：[WinX64.pubxml](file:///d:/_TraeProject/debugging_library/src/FieldKb.Client.Wpf/Properties/PublishProfiles/WinX64.pubxml)
- 或命令行：
  - `dotnet publish src/FieldKb.Client.Wpf/FieldKb.Client.Wpf.csproj -c Release -r win-x64 --self-contained false -o artifacts/publish/win-x64`

打包为 zip（PowerShell）：

- `Compress-Archive -Path artifacts/publish/win-x64/* -DestinationPath artifacts/DebugSummaryPlatform_portable_win-x64.zip -Force`
- 或使用脚本：[pack-portable.ps1](file:///d:/_TraeProject/debugging_library/tools/pack-portable.ps1)

运行：

- 解压后执行 `FieldKb.Client.Wpf.exe`

## 安装包（推荐 Inno Setup）

原因：

- 可安装到用户可写目录（如 `%LocalAppData%\\Programs\\DebugSummaryPlatform`），确保 `<程序目录>` 可写（数据库/附件/日志/配置均在同级目录）
- 建议安装目录使用英文路径（避免部分环境对中文目录兼容性差），例如 `%LocalAppData%\\Programs\\DebugSummaryPlatform`
- 支持卸载、开始菜单快捷方式、桌面快捷方式

步骤：

1) 先按“免安装版”生成发布目录：`artifacts/publish/win-x64/`
2) 安装 Inno Setup（外部工具）
3) 编写安装脚本（示例）并编译生成安装包

安装体验说明（满足“可选安装路径 + 可选桌面快捷方式”）：

- 安装路径：Inno Setup 默认会显示“选择目标位置”页面，用户可修改安装目录；建议默认安装到 `{localappdata}\Programs\DebugSummaryPlatform`（无管理员权限即可写入，且程序目录可写，便于同目录落盘数据库/附件/日志/配置）。
- 桌面快捷方式：通过 `Tasks` 提供“创建桌面快捷方式”勾选项，默认不勾选；用户可在安装过程中自行选择。

示例脚本（保存为 `tools/installer.iss`）：

```
[Setup]
AppName=调试资料汇总平台
AppVersion=1.0.0
DefaultDirName={localappdata}\Programs\DebugSummaryPlatform
DisableProgramGroupPage=yes
OutputDir=artifacts
OutputBaseFilename=DebugSummaryPlatform_Setup_win-x64

[Files]
Source: "artifacts\publish\win-x64\*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs

[Icons]
Name: "{autoprograms}\调试资料汇总平台"; Filename: "{app}\FieldKb.Client.Wpf.exe"
Name: "{autodesktop}\调试资料汇总平台"; Filename: "{app}\FieldKb.Client.Wpf.exe"; Tasks: desktopicon

[Tasks]
Name: "desktopicon"; Description: "Create a desktop icon"; Flags: unchecked
```

仓库已提供示例脚本，可直接修改版本号并使用 Inno Setup 编译：

- [installer.iss](file:///d:/_TraeProject/debugging_library/tools/installer.iss)

可选：一键打包脚本（会先 publish，再调用 Inno Setup 编译）：

- [pack-inno-setup.ps1](file:///d:/_TraeProject/debugging_library/tools/pack-inno-setup.ps1)

## MSI 安装包（WiX Toolset）

说明：

- 采用 WiX Toolset（MSBuild SDK）生成 `.msi`，无需额外安装 WiX（通过 NuGet 还原工具链）
- 当前 MSI 为 `perUser`（默认安装到 LocalAppData，可不需要管理员权限）
- 安装目录：安装向导会显示“选择目标位置”，用户可自定义安装路径
- 桌面快捷方式：可选项，默认勾选；选择“自定义安装”时可取消

生成 MSI（会自动先 publish 再 harvest 文件）：

- `dotnet build installer/wix/DebugSummaryPlatform.wixproj -c Release`
- 或使用脚本：[pack-msi.ps1](file:///d:/_TraeProject/debugging_library/tools/pack-msi.ps1)

输出位置：

- `installer/wix/bin/x64/Release/DebugSummaryPlatform.msi`

## 后续可选增强

- SelfContained + SingleFile（减少环境依赖）
- MSI（WiX Toolset）或 MSIX（更现代的部署体验）
- 自动更新（离线环境可用“增量包 + 校验”方式分发）
