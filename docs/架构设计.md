# 架构设计（原型）

## 目标

- 完全离线运行：个人库/总库均为本地应用 + 本地 SQLite 文件
- 可演进：数据模型、包格式、数据库迁移互相解耦并可版本化
- 易维护：遵循分层与依赖倒置，核心用例以接口表达，持久化与 UI 可替换

## 分层与职责

解决方案项目结构：

- Domain：业务实体与稳定枚举，尽量不依赖外部库
- Application：用例接口与跨层 DTO（抽象 Store、导入导出服务接口等）
- Infrastructure：SQLite/文件系统/导入导出包等实现
- Client.Wpf：WPF UI 与交互、DI 组合根
- Tests：回归测试（存储检索、导入导出）

依赖方向：

- Domain 无依赖或仅依赖 BCL
- Application 依赖 Domain
- Infrastructure 依赖 Application + Domain
- Client 依赖 Application + Infrastructure + Domain

## 核心数据流

### 1) 录入/更新问题

- UI 收集字段 → 组装 Problem → IKbStore.UpsertProblemAsync
- Store 写入主表 problem 并同步刷新 FTS 表 problem_fts

### 2) 搜索

- UI 输入 query/筛选条件 → IKbStore.SearchProblemsAsync / CountProblemsAsync
- Store 对 title/现象/原因/方案/环境 JSON 做大小写不敏感的“包含匹配”，并返回命中列表（含 title/updatedAtUtc/snippet）
- UI 左侧分页展示（limit/offset），选择条目时再按 id 拉取详情并展示

### 3) 离线导出

- UI 选择导出目录/模式/对端标识 → IPackageTransferService.ExportAsync
- 导出端根据 exportState 或外部指定水位筛选 `updatedAtUtc > watermark`
- 生成 `data/*.jsonl`、复制附件文件、写入 manifest 与 sha256 校验
- 更新 exportState

### 4) 离线导入

- UI 选择 zip 包 → IPackageTransferService.ImportAsync
- 解压、校验 sha256
- 逐行读取 JSONL，按“时间戳 + 实例ID”规则合并
- 冲突写入 conflictRecord，成功写入对应业务表并维护 FTS
- 复制附件到本地 attachments 目录
- 更新 syncState

## 可替换点（后续优化常用抓手）

- 存储层：从 SQLite 切换到 LiteDB/Embedded Postgres 等（保持 IKbStore）
- 搜索：可切回/增强 FTS5（高亮/权重/评分），或升级 Lucene.NET（保持 SearchProblemsAsync 输出契约）
- 包格式：升级加密/签名、支持增量 patch 与分片（保持 schemaVersion）
- UI：WPF → WinUI 3 或 WebView2（保持 Application 接口）
