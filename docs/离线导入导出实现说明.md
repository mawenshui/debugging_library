# 离线导入导出实现说明（原型）

## 目标

- 用“可拷贝文件”的方式完成个人库与总库的离线数据交换
- 支持全量与增量，且增量不依赖在线服务
- 具备可审计性：manifest 记录包信息与校验

## 包内容

- `manifest.json`：包元信息（schemaVersion、导出者实例、模式、水位、校验）
- `data/*.jsonl`：按实体类型拆分的变更行（每行一个 JSON）
- `attachments/*`：附件实体引用的文件（以 contentHash 命名）

## 校验策略（当前实现）

- 对除 `manifest.json` 外的所有文件计算 SHA-256
- 将相对路径 → sha256 写入 `manifest.checksums`
- 导入时逐个比对，任一不匹配则拒绝导入

## 增量策略（水位）

导出：

- Full：不带 baseWatermarkUtc，导出所有记录
- Incremental：以 `updatedAtUtc > baseWatermarkUtc` 筛选导出
  - baseWatermarkUtc 默认取 exportState 内 lastExportedUpdatedAtUtc
  - 也允许由调用方显式传入 UpdatedAfterUtc 覆盖

导入：

- 每条记录按 `updatedAtUtc` 比较新旧
- 若时间相同，按 `updatedByInstanceId` 字典序作为稳定 tie-breaker
- 当导入记录“更旧”时，写入 conflictRecord 并跳过覆盖

## 冲突与报告

- ImportReport 统计：
  - 总计：ImportedCount / SkippedCount / ConflictCount / Errors（按所有实体合计）
  - 分项：ProblemsImportedCount 等（便于 UI 只展示“问题条数”并避免误解）
- conflictRecord 保存：entityType/entityId、两份 json、对应时间；冲突中心会以“可读摘要 + 差异提示”展示两版内容并支持人工决议

## 代码入口

- 接口：[IPackageTransferService.cs](file:///d:/_TraeProject/debugging_library/src/FieldKb.Application/Abstractions/IPackageTransferService.cs)
- 实现：[SqlitePackageTransferService.cs](file:///d:/_TraeProject/debugging_library/src/FieldKb.Infrastructure/ImportExport/SqlitePackageTransferService.cs)
- 冲突处理 UI：[ConflictCenterWindow.xaml](file:///d:/_TraeProject/debugging_library/src/FieldKb.Client.Wpf/ConflictCenterWindow.xaml)
