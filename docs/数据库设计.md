# 数据库设计（SQLite）

## 文件位置

- 数据库：`<程序目录>\\kb.sqlite`
- 附件目录：`<程序目录>\\attachments\\{contentHash}`
- 日志目录：`<程序目录>\\logs\\`
- 配置目录：`<程序目录>\\config\\`
  - 应用配置：`<程序目录>\\config\\appsettings.json`
  - 实例标识：`<程序目录>\\config\\instance.json`

## 迁移机制

- 使用 `PRAGMA user_version` 作为 schema 版本号
- 应用启动时执行迁移，确保表与索引就绪
- 初始化 PRAGMA：
  - `foreign_keys=ON`
  - `journal_mode=WAL`（提升并发读写体验）
  - `synchronous=NORMAL`
- 连接默认超时：`DefaultTimeout=2`（避免长时间锁等待导致 UI 无响应；极端锁冲突会在 UI 层自动重试一次并提示）

迁移入口（代码参考）：

- [SqliteMigrations.cs](file:///d:/_TraeProject/debugging_library/src/FieldKb.Infrastructure/Sqlite/SqliteMigrations.cs)

## 表结构（v1/v2）

### problem

- 主键：id (TEXT)
- 软删除：isDeleted + deletedAtUtc
- 审计：createdAtUtc/createdBy/updatedAtUtc/updatedByInstanceId
- 来源：sourceKind (0=Personal,1=Corporate)

### tag / problemTag / attachment

- 统一软删除与 updatedAtUtc/updatedByInstanceId

### problem_fts（FTS5）

- 虚拟表：用于全文检索
- 字段：title/symptom/rootCause/solution/environmentJson
- 同步策略：写入 problem 后，删除并重建对应 problemId 的 FTS 行
- 当前检索实现：SearchProblemsAsync 采用主表字段的包含匹配（非 FTS MATCH）；problem_fts 保留为后续增强点（高亮/权重/评分）
- 当前评分策略：包含匹配命中后按字段权重累加评分（title 权重更高），用于搜索结果排序

### syncState

- 用途：记录“从某 remote 导入到本端”的水位
- 主键：(localInstanceId, remoteInstanceId)

### exportState

- 用途：记录“本端导出给某 remote”的水位
- 主键：(localInstanceId, remoteInstanceId)

### conflictRecord

- 用途：记录导入冲突（保留本地与导入快照、时间）

## 数据一致性约束（建议）

- `updatedAtUtc` 必须为 UTC ISO-8601 字符串
- `updatedByInstanceId` 必须非空
- `isDeleted` 仅允许 0/1
