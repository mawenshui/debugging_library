## 现状与问题定位

* 当前 XLSX 批量导出会生成 3 张表：Problems / ProblemTags / Attachments（标签与附件都是“分表表达”），但现有“表单导入”仅覆盖问题表单导入，导致导入后标签/附件关联缺失。

* 附件在本地是“内容哈希(contentHash) -> 文件”的外置存储（LocalAppData/attachments/<contentHash>），XLSX 里只有附件元数据，不包含二进制内容，因此单靠 Excel 文件无法同步附件内容。

## 目标

* 让“表单导入”能够完整恢复：问题、标签、问题-标签关联、附件元数据与附件文件内容。

* 对于仅有 .xlsx 的导入：至少恢复问题与标签关系；对附件给出明确提示（不静默丢失）。

* 优化附件在“表单导入/导出”场景下的可移植性：提供单文件交付（建议 zip 包），保证附件可随导出一起带走。

## 技术方案

### 1) 扩展导出：提供“Excel + 附件包（zip）”

* 在现有 BulkExport 的基础上新增一种导出形式（例如 XlsxBundle）：

  * 生成 data.xlsx（继续包含 Problems / ProblemTags / Attachments）。

  * 同时把本地附件文件按 contentHash 复制到包内 attachments/<contentHash>。

  * 打包为一个 zip（用户只需传一个文件即可导入）。

* 可选增强（为完善导入一致性）：在 xlsx 中新增 Tags 表（导出完整 tag 字段），避免仅靠 ProblemTags 的 TagName 推断造成信息缺失。

### 2) 实现 XLSX 读取器（与现有写法对称）

* 由于当前 XLSX 写入是 inlineStr 的极简 OpenXML（无 sharedStrings），实现一个同样“极简但足够”的读取器：

  * 读取 xl/workbook.xml + workbook.xml.rels，定位 sheetName -> sheet\*.xml。

  * 解析 sheetData/row/c（inlineStr）得到二维字符串表。

  * 做容错：缺列/空单元格/多余列/用户手工编辑导致的空行。

### 3) 实现“表单导入”对齐导出格式

* 支持两种输入：

  * .zip：提取 data.xlsx + attachments 文件夹，完整导入。

  * .xlsx：只导入 Problems + 标签关系；若存在 Attachments 行则提示“缺少附件文件包，无法恢复附件内容”。

* 导入顺序：

  1. Problems：按 ProblemId upsert 写入。
  2. Tags（若有）：按 TagId upsert；若没有 Tags 表，则从 ProblemTags 的 TagId/TagName 补齐（缺字段用当前时间与本机实例信息填充）。
  3. ProblemTags：按 ProblemId 聚合 tagIds，调用 SetTagsForProblem 写入关联（或直接 SQL 写入），忽略已删除标记。
  4. Attachments：

     * 校验 zip 内是否存在 attachments/<contentHash>，并将文件复制到本地附件目录（按 contentHash 去重）。

     * 写入附件元数据并关联到 ProblemId（必要时做 size/hash 校验）。

* 冲突策略：默认“若本地 updatedAtUtc 更新则跳过并记录冲突”，与现有包导入行为一致；可在 UI 增加“强制覆盖/仅新增”选项。

### 4) 附件存储方式优化（聚焦可移植性）

* 保留现有“contentHash 文件去重存储”作为本地最优方案。

* 为表单导出新增“可携带附件内容”的 bundle，使附件同步不再依赖本机 LocalAppData。

* 可选增强：在 bundle 内额外生成可读文件名副本（例如 attachments\_by\_name/<ProblemId>/<OriginalFileName>），方便人工查看，但导入仍以 contentHash 为准。

## UI/交互改动

* 在“表单导入”窗口增加：选择文件（.xlsx/.zip）、预检（统计将导入的问题/标签/附件数量、缺失附件数）、执行导入、导入报告（成功/跳过/冲突/错误）。

* 在“批量导出”窗口增加：导出格式选项“Excel（含附件包 .zip）”。

## 测试与验收

* 新增端到端测试：

  * 构造一条问题 + 2 个标签 + 1 个附件文件；导出为 xlsx bundle；导入到新库；断言标签关联与附件文件可在本地按 contentHash 找到且内容一致。

  * 仅 .xlsx 导入测试：能恢复 Problems 与标签关联，同时报告附件缺失。

如果确认该方案，我将按以上步骤开始实现，并确保对现有纯 XLSX 导出保持兼容（不影响原有查看用途），同时提供 zip bundle 作为“可完整恢复附件”的推荐导出格式。

<br />

除上述问题外，无论是导入增量还是全量zip包时，出现的冲突应该支持批量或多选处理，不能仅支持一个个处理
