# 数据模型与离线同步包规范（v0）

本文档用于约束个人库与总库在**完全离线**条件下的数据交换与合并行为，确保实现可重复、可审计、可演进。

## 术语

- 实例（Instance）：一个数据库的持有者与运行环境。个人库与总库各是一个实例。
- 导入/导出包（Package）：用于离线传输的 ZIP 文件，包含数据变更集与附件。
- 水位（Watermark）：用于增量导出的“已导入到对端的最大变更位置”。

## 全局约束

- 所有业务实体使用全局唯一主键 `id`（UUID v4 或 ULID 字符串）。
- 删除采用软删除：`isDeleted=1`，并保留 `deletedAtUtc`。
- 时间统一使用 `UTC`，ISO-8601 字符串（如 `2026-01-20T13:45:30Z`）。
- 每条记录必须包含 `updatedAtUtc` 与 `updatedByInstanceId`，用于合并与审计。

## 业务实体（MVP）

### Problem（问题）

- id: string
- title: string
- symptom: string
- rootCause: string
- solution: string
- environmentJson: string（JSON 字符串，允许扩展字段；可包含元字段 __professionid 用于职业筛选与模板选择）
- severity: int（0-4：低/中/高/致命/阻断，可配置）
- status: int（0-3：草稿/已验证/已发布/已归档，可配置）
- createdAtUtc: string
- createdBy: string（可用本机用户名或手工录入）
- updatedAtUtc: string
- updatedByInstanceId: string
- isDeleted: int（0/1）
- deletedAtUtc: string?（可空）
- sourceKind: int（0=Personal, 1=Corporate）

### Tag（标签）

- id: string
- name: string（唯一性建议按同一实例约束）
- createdAtUtc: string
- updatedAtUtc: string
- updatedByInstanceId: string
- isDeleted: int（0/1）

### ProblemTag（关联）

- id: string
- problemId: string
- tagId: string
- createdAtUtc: string
- updatedAtUtc: string
- updatedByInstanceId: string
- isDeleted: int（0/1）

### Attachment（附件元数据）

- id: string
- problemId: string
- originalFileName: string
- contentHash: string（SHA-256，十六进制）
- sizeBytes: long
- mimeType: string
- createdAtUtc: string
- updatedAtUtc: string
- updatedByInstanceId: string
- isDeleted: int（0/1）

附件文件本体按 `contentHash` 存储，实现跨问题/跨包去重。

## 增量导出与水位设计

### SyncState（每对端维度）

- localInstanceId: string
- remoteInstanceId: string
- lastImportedUpdatedAtUtc: string（从该 remote 导入时已处理的最大 updatedAtUtc）
- lastImportedPackageId: string

增量导出规则（简单可靠版本）：

- 导出“自某对端水位之后”更新的记录：`updatedAtUtc > lastImportedUpdatedAtUtc`
- 若 `updatedAtUtc` 相同导致边界问题，导出端需要在水位上采用“严格大于”并在导入端去重（按 id+updatedAtUtc）。

后续若需要更强一致性，可升级为操作日志（ChangeLog）与序列号水位（seq）。

### ExportState（每对端维度）

除“已从对端导入到本端”的水位外，还需要记录“本端已经导出给对端”的水位，以便：

- 做本端增量导出（避免反复导出同一批记录）
- 快速定位某次导出的包与上次导出的最大更新时间

字段（建议）：

- localInstanceId: string
- remoteInstanceId: string
- lastExportedUpdatedAtUtc: string（导出给该 remote 的最大 updatedAtUtc）
- lastExportedPackageId: string

## 合并与冲突规则（v0）

导入任意实体时：

1. 若本地不存在该 `id`，直接插入。
2. 若本地存在：比较 `updatedAtUtc`。
   - 导入记录更“新”（updatedAtUtc 更大）：覆盖写入。
   - 导入记录更“旧”：忽略写入。
   - 时间相同：按 `updatedByInstanceId` 字典序作为稳定 tie-breaker（保证确定性）。

冲突定义：

- 同一 `id` 在两端都被修改，且两端修改时间非常接近或字段差异较大时，仍可能发生“业务冲突”（例如两边都补全了不同的 rootCause）。
- v0 做法：覆盖写入同时写入 `ConflictRecord`（仅用于 UI 展示与人工处理），保留两份字段快照。

## 导入/导出包格式（ZIP）

文件名建议：

- `kbpkg_{exporterInstanceId}_{createdAtUtc}_{mode}.zip`

包内结构：

- `/manifest.json`
- `/data/problems.jsonl`
- `/data/tags.jsonl`
- `/data/problemTags.jsonl`
- `/data/attachments.jsonl`
- `/attachments/{contentHash}`（附件文件本体，原始扩展名可保留在元数据）

### manifest.json（示例字段）

- packageId: string（UUID）
- schemaVersion: int（v0=0）
- createdAtUtc: string
- exporterInstanceId: string
- exporterKind: string（Personal/Corporate）
- mode: string（Full/Incremental）
- baseWatermarkUtc: string?（增量包起点，可空）
- maxUpdatedAtUtc: string（本包内记录的最大 updatedAtUtc）
- recordCounts: object（各 jsonl 行数）
- checksums: object（key=相对路径，value=sha256）

### JSONL 记录格式

每行一个 JSON 对象，便于流式写入/读取与大数据量处理。

统一字段：

- op: string（Upsert/Delete）
- entity: object（对应实体字段）

`Delete` 操作仍建议以软删除 Upsert 的方式表达（`isDeleted=1`），以降低导入复杂度；保留 op 主要为未来扩展。

## 版本演进策略

- schemaVersion 递增
- 导入端根据 schemaVersion 做兼容处理：不认识的字段忽略，缺失字段使用默认值
- 数据库 schema 迁移与包 schema 迁移解耦：包可先兼容旧库，再逐步升级

## 当前实现对齐（原型）

当前代码实现对齐了本文档 v0 的核心约束：

- SQLite schema：problem/tag/problemTag/attachment + syncState + conflictRecord + exportState（见迁移脚本）
- 包结构：ZIP + manifest.json + data/*.jsonl + attachments/*
- 校验：对包内除 manifest.json 外的所有文件计算 sha256，并写入 manifest.checksums
