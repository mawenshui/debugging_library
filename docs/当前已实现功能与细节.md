# 当前已实现功能与细节

本文档用于快速说明：当前原型已经具备哪些能力、哪些细节已落地、对应入口与数据落盘位置，便于交接与后续迭代。

## 功能清单（用户可感知）

### 1) 问题录入

- 新建问题记录：标题/现象/原因/解决方案/环境信息/标签/附件
- 环境信息为“结构化字段 + 自定义扩展字段”的混合表单：
  - 固定字段：按职业/角色动态渲染（每类 6–8 个，见“职业模式与字段模板”）
  - 固定字段可配置：设置 → 职业设置 中可按职业勾选默认固定字段（最多 8 个），保存后立即影响新建/编辑表单
  - 自定义字段：键值对列表，Key 支持可编辑下拉（常用中文字段提示）
  - 校验：标题必填；IP 格式校验；端口范围校验（1–65535）
- 支持编辑与软删除：
  - 右侧详情区可编辑/删除（软删除）
  - 编辑窗口支持滚动显示，窗口较小时不遮挡字段

### 2) 搜索与复盘

- 搜索框输入即检索（默认策略为 Hybrid：优先 FTS5，若无结果自动回退到“包含匹配”）
- 多关键字：空格分词；FTS 下可配置 AND/OR 组合与前缀匹配（用于更宽松的模糊召回）
- 未输入搜索词：左侧命中列表按更新时间倒序分页展示全部条目（每页最多 100 条）
- 左侧：命中列表（标题 + 摘要 snippet；支持关键词高亮；未搜索时摘要为空）
- 有搜索词时：FTS 下按 bm25 排序；回退到包含匹配时按字段权重评分排序（title 权重更高）
- 右侧：详情展示（现象/原因/方案/环境信息）
- 环境信息展示为“key: value”列表，而非原始 JSON
- 支持标签筛选与清空筛选
- 支持职业筛选（全部/未标记/7 类职业）
- 下拉框交互：点击下拉框整行可展开/收起下拉菜单（不必精确点击右侧箭头）
- 分页区展示总条数：第 N 页（共 M 条）

### 3) 离线导入/导出

- 导入：选择离线包 zip → 校验 → 合并写入 → 输出导入报告（UI 提示以“问题条数”为主；日志保留实体分项统计）
- 导出：
  - 导出（全量）：导出所有记录
  - 导出（增量）：基于对端标识的水位导出新增/更新记录
- 批量导出（查看用）：支持导出为 Excel/CSV/JSONL，支持按职业/标签/更新时间范围筛选
- 表单导入（Excel）：支持从 Excel（.xlsx）导入问题数据，支持字段映射与校验报告
- 支持“个人库 ↔ 总库”的双向离线交换（通过文件传输）
- 支持“个人库 ↔ 总库”的局域网交换（无需拷贝文件）：
  - 拉取导入：从对端导出离线包并导入本机
  - 推送导入：本机导出离线包并让对端直接导入
  - 默认需要共享密钥鉴权（见 `config/appsettings.json` 的 `LanExchange` 节点）
- 冲突：导入发生冲突会写入冲突记录，可在“冲突中心”中查看差异并人工决议（保留本地/采用导入）

### 4) 设置与用户标识

- 主界面提供“设置”入口
- 可设置“当前用户名称”，并持久化到 `<程序目录>\config\appsettings.json`
- 可设置“职业/角色”，并持久化到 `<程序目录>\config\appsettings.json`
- 主界面“本机实例ID”支持点击复制，便于多终端离线交换时快速粘贴
- 设置页提供“职业设置”入口：按职业配置默认固定字段（最多 8 个），支持新增自定义字段
- 新建问题时 `createdBy` 写入当前用户名称（未配置则回退系统用户名）
- 用户名限制（防止存储异常）：最长 32 字符；仅允许中文/字母/数字/空格/下划线/短横线/点
- 职业/角色会影响问题编辑页的环境信息模板（固定字段 6–8 + 推荐自定义字段/默认模板行），不影响导入导出兼容性（仍写入 environmentJson）
- 提供“关于”窗口：展示名称、版本、作者、运行时与操作系统信息
- “关于”窗口布局自适应：默认尺寸可完整显示；窗口较小时提供滚动条

### 5) 安全与高危操作

- 设置页提供“操作密码”：
  - 用于执行批量删除等高危操作
  - 本机仅保存密码哈希（PBKDF2），不保存明文
- 数据清理（危险）：设置页提供“批量删除问题”入口
  - 物理删除（无法恢复），支持按职业/标签/更新时间范围筛选
  - 删除前必须输入并校验操作密码

### 6) 日志与可观测性

- 主界面提供“日志”入口，可查看本次启动以来的历史日志并实时追加
- 日志同时写入本地文件（每次启动一个文件）
- 捕获 UI 未处理异常并写入日志（避免静默无响应）

### 7) UI 主题与一致性

- 全局浅色玻璃渐变主题：常用控件统一样式（TextBox/ComboBox/Button/ScrollBar/ListBox/DataGrid 等）
- 日期选择/表格/密码输入：DatePicker、DataGrid、PasswordBox 全局主题化，避免默认白底黑字导致对比度不一致
- 标题栏：全局自定义标题栏样式，支持拖拽/双击最大化/右键系统菜单/最小化最大化关闭；最大化时不会被任务栏遮挡
- 文字清晰度：浅色背景下统一文字渲染策略与像素对齐，减少发虚与锯齿

## 关键细节（实现层面）

### 存储与检索

- 数据库：SQLite 单文件
- 数据库并发：启用 WAL 以提升并发读写体验；极端锁冲突会弹窗提示“数据库忙”，并自动重试一次
- 检索：支持三种模式（LegacyContains / Fts / Hybrid），默认 Hybrid；可在 `config/appsettings.json` 的 `Search` 节点配置
- LegacyContains：对 `title/symptom/rootCause/solution/environmentJson` 做大小写不敏感的包含匹配；有搜索词时按字段权重评分排序（title 权重更高）
- Fts：基于 SQLite FTS5（problem_fts）做全文检索，支持前缀匹配与可选 AND/OR 组合，并按 bm25 排序
- 分页：limit/offset；UI 侧每页最多 100 条
- 写入问题时会维护 problem_fts（用于 FTS 模式；Hybrid 会优先使用 FTS）
- 删除策略：软删除（isDeleted 标记），被软删除记录不进入 FTS

### 离线包与合并规则

- 包格式：ZIP + `manifest.json` + `data/*.jsonl` + `attachments/*`
- 完整性：sha256 校验（manifest 中记录路径→hash）
- 合并规则（稳定 LWW）：
  - 若导入记录 updatedAtUtc 更新：覆盖写入
  - 若更旧：跳过
  - 若时间相同：按 updatedByInstanceId 字典序 tie-breaker，保证确定性
- 冲突记录：导入端会将冲突写入 conflictRecord（用于后续 UI 可视化处理）

### 增量水位

- UI 维护“对端标识”，用于增量导出/导入水位的维度
- 数据库中维护：
  - syncState：记录“从某 remote 导入到本端”的水位
  - exportState：记录“本端导出给某 remote”的水位

## 配置与数据落盘位置

- 配置固定目录：`<程序目录>\config\`
  - `appsettings.json`：应用配置（实例类型、当前用户名、默认对端标识等）
  - `instance.json`：本机实例标识（首次运行生成）
- 数据与附件：`<程序目录>\`
  - `kb.sqlite`：SQLite 数据库
  - `attachments\`：附件对象存储（按 contentHash，UI 已支持添加、应用内预览（图片/文本类）与外部打开）
  - `logs\`：日志文件（每次启动一个 `.log` 文件）

## 打包与分发（已提供脚本/示例）

- 免安装包：发布到目录并压缩为 zip（见 `tools/pack-portable.ps1`）
- 安装包：提供 Inno Setup 示例脚本（见 `tools/installer.iss`）

## 已知限制（当前阶段）

- 附件预览目前支持图片与文本类文件；其他类型将提示使用外部打开

## 相关文档与代码入口

- 文档入口：[README.md](file:///d:/_TraeProject/debugging_library/docs/README.md)
- 数据模型与包规范：[数据模型与离线同步包规范.md](file:///d:/_TraeProject/debugging_library/docs/数据模型与离线同步包规范.md)
- 数据库设计：[数据库设计.md](file:///d:/_TraeProject/debugging_library/docs/数据库设计.md)
- 离线导入导出实现：[离线导入导出实现说明.md](file:///d:/_TraeProject/debugging_library/docs/离线导入导出实现说明.md)
- UI 操作流：[UI原型与操作流.md](file:///d:/_TraeProject/debugging_library/docs/UI原型与操作流.md)
- 主题预览（10套方案）：[theme-presets.html](file:///d:/_TraeProject/debugging_library/docs/theme-presets.html)
- 发布与打包：[发布与打包.md](file:///d:/_TraeProject/debugging_library/docs/发布与打包.md)
